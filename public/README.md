# アリスタイルフォーム

## デモ

http://demo.test.alistyle.jp/contact/

## 動作環境

PHP 7.0 以上

##  ディレクトリ構造

※の付いたファイル＝主に編集が必要なファイル。  
ファイル数はややあるものの、いじるところは割と限られている。

~~~
[contact]
   │
   ├ index.php
   ├ index.template.php    ※入力画面テンプレート
   ├ confirm.template.php  ※確認画面テンプレート
   ├ thanks.html           ※完了画面テンプレート
   │
   └ [form]
       │
       ├ [etc]
       │   ├ FormConfig.php                    ※フォーム設定ファイル
       │   ├ email_for_admin.template.php  ※管理者宛メールテンプレート
       │   └ email_for_user.template.php   ※自動返信メールテンプレート
       │
       └ [lib]
           ├ FormConstraint.php
           ├ Session.php
           ├ functions.php
           │
           └ [PHPMailer]
               ├ LICENSE
               ├ class.jphpmailer.php
               ├ class.phpmailer.php
               ├ class.pop3.php
               ├ class.smtp.php
               │
               └ [language]
                   └ phpmailer.lang-ja.php
~~~

## 基本的な使い方

各種テンプレートと設定ファイルを編集するだけ。

### index.template.php

入力画面。  
まずは普通にコーディングし、フォーム部分を  
`<form method="post" action="">` ～ `</form>`  
で括る。actionは空のままでOK。

formタグ内には必ず以下タグを挿入する。

```php
<input type="hidden" name="mode" value="confirm">
<input type="hidden" name="token" value="<?php echo h($token); ?>">
```

フォームの根幹となる input タグは何だかゴチャゴチャ書いてあるけど、  
やっていることとしては

- エラーを表示する
- （戻ってきたときに）入力内容を保持しておく

の2点だけ。サンプルを参考にしつつ好きに書けばいい。  
inputタグの `name` についても好きなものを入れて問題ないけど、  
後述する設定ファイルに合わせること。

このファイルは直接アクセスされると不適切な表示になる場合があるため、  
ファイルの先頭に以下の記述を入れておく。

```php
<?php
    if( basename($_SERVER['PHP_SELF']) === basename(__FILE__) ){
        require_once(dirname(__FILE__) . '/form/lib/functions.php');
        http_status(404);
    }
?>
```

### confirm.template.php

確認画面。  
こちらも普通にコーディングするところまでは同じ。  
ただし、フォーム部分を全てformタグでは括るのではなく、  
送信ボタン部分のみを入力画面と同じformタグで括る。  
また、以下のタグをformタグ内に含めること。  
これがないといつまで経っても送信が完了せず、  
入力画面と確認画面を行ったり来たりするハメになる。

```php
<?php foreach($input as $key => $i): ?>
    <input type="hidden" name="<?php echo h($key); ?>" value="<?php echo h($i['value']); ?>">
<?php endforeach; ?>
<input type="hidden" name="mode" value="submit">
<input type="hidden" name="token" value="<?php echo h($token); ?>">
```

入力画面同様、ファイルの先頭には以下を記述すること。

```php
<?php
    if( basename($_SERVER['PHP_SELF']) === basename(__FILE__) ){
        require_once(dirname(__FILE__) . '/form/lib/functions.php');
        http_status(404);
    }
?>
```

入力された値は以下のタグを挿入すると表示可能。  
後述の設定ファイルを準備していないと何も表示されないので注意。

```php
<?php echo h($input['HTMLタグのname部分']['value']); ?>
```

### thanks.html

完了画面。  
何の変哲もないただのHTMLなので、自由にコーディングしてOK。

### form/etc/config.php

設定ファイル。  

#### `array getColumns()`

入力を受け付ける項目、及び各項目の制約を設定する。  
**ここを変更しないと入力チェックが正しく動かず、大変困ることになる。**  
（後述の「とてもよくある質問」も参照）

- **`name`**  
  項目名。  
  エラー表示に利用される。

- **`type`**  
  入力タイプ。  
  通常は `text` だけど、変更すると自動で入力値を変換したり制限してくれる。
  
  - `hiragana`  
    ひらがなのみ。カタカナが入力された場合、ひらがなに変換される。  
    主に「ふりがな」向け。
    
  - `katakana`  
    カタカナのみ。上記と逆。これも「フリガナ」向け。
    
  - `number`  
    半角数字のみ。全角数字は半角に変換される。  
    「10進数の自然数かどうか」をチェックしているわけではないので、  
    `0100` のように先頭が0で始まっていても特に弾かない点に注意。
    
  - `numberh`  
    半角数字＋ハイフンのみ。これも全角→半角変換される。電話番号向き。
    
  - `zipcode`  
    `numberh` に郵便番号の書式制限を加えたもの。  
    数字7桁で、ハイフンは入っていてもいなくても可。
    
  - `phone`  
    `numberh` に日本の電話番号っぽい文字列かざっくりチェックを加えたもの。
    
  - `email`  
    メールアドレスっぽい文字列かざっくりチェックを行うもの。全角英数は半角英数に変換。    
    決して厳密なものではないので、仕様上正しくないメールアドレスも通るけど、  
    逆に言うと「仕様違反だけど実在するメールアドレス」は通る。  
    例えば `@` の直前に `.` が入ってると本来はRFC違反だけど、  
    ガラケー時代に作られたメールアドレスには実在するので、弾くと不都合な場合がある。

  - `zenkaku`  
    全角への文字変換のみ実施。特にエラーは出さない。
  
  - `hankaku`  
    半角への文字変換のみ実施。特にエラーは出さない。

- **`value`**  
  デフォルト値。  
  主に、ラジオボタン/プルダウン/チェックボックスで最初から選択させておきたい場合に使う。
  チェックボックスの場合は配列で指定する。
  
- **`required`**  
  必須かどうか。`true` で必須、`false` で任意。
  
- **`constraints`**  
  その他の制約。typeだけではどうにもならない制約を定義できる。
  
  - `new StringWidthConstraint(最小文字数, 最大文字数)`  
    文字幅制約。いわゆる文字数チェックだけど、半角を1、全角を2として数える。  
    
  - `new BetweenConstraint(最小値, 最大値)`  
    範囲制約。数値を入力する欄で使用。  
    
  - `new MatchUpAnotherFieldConstraint('フィールド名')`  
    他フィールド同一制約。メールアドレス等、確認で2回入力させたいときに使う。  
    この制約を付けた項目は `type` を `text` にするのがオススメ。  
    2重チェックになっちゃってエラー文がクドくなる。
    
  - `new SplitJapanPhoneNumberConstraint('2つ目のフィールド名', '3つ目のフィールド名')`  
    分割電話番号制約。  
    よくある、電話番号を分けて入力させるための制約。  
    使うときは、最初の入力フィールドに対してこの制約を書く。  

  - `new SplitJapanZipCodeConstraint('2つ目のフィールド名')`  
      分割郵便番号制約。  
      よくある、郵便番号を分けて入力させるための制約。  
      使うときは、最初の入力フィールドに対してこの制約を書く。 

  - `new RequiredByAnotherFieldConstraint('他フィールド名', '他フィールド値')`  
    他フィールド依存必須制約。他のフィールドが○○だったら必須に、というときに。  
    コールバックでの指定も可能。  
    `new RequiredByAnotherFieldConstraint('他フィールド名', function($value){ ～ }, true)`  
    必須のときに `true` を返すように実装すればいい。
    
  - `new ChooseOneConstraint(array('選択肢1', '選択肢2……'))`  
    選択肢制約。  
    `<input type="radio">` や `<select>` でちゃんと選択肢から選んでほしいときに。  
    同じ `name` の `<input type="checkbox">` を複数配置するときにも使える。
    
  - `new RequiredChooseSomeFieldConstraint(他フィールド名の配列,最低選択数, 最大選択数)`  
    複数フィールドを入力/選択する際の個数制約
    
    `<input type="checkbox">` での利用を想定  
    (例) フィールドAは複数選択可能なチェックボックスで、選択肢の中から最低1つ以上、最大2つまで選択しなければならない  
        　→Aに new ChooseSomeFieldConstraint(null, 1, 2) 
    
    `name` が異なるフィールド同士を設定する際はいずれか1つのフィールドにこの制約をつければOK  
    (例) フィールドA、B、Cはチェックボックスで、この中から最低1つ以上、最大2つまで選択しなければならない  
    　→A、B、Cのいずれか一つに new ChooseSomeFieldConstraint(['A', 'B', 'C'], 1, 2)  
    　　※エラーメッセージは制約を付けたフィールドにのみ設定される
  
  - `new IsDateExistingConstraint('2つ目のフィールド名', '3つ目のフィールド名')`  
    実在している日付か確認する  
    「生年月日」などの日付が本当に存在してるか確認します。  
    使うときは、最初の入力フィールドに対してこの制約を書く。
  
  - `new CallbackConstraint(function($key, $value, $name, $constraint){ ～ })`  
    コールバック制約。もう自分でバリデーションさせろ！って人向け。    
    諸々全部渡すので自分で判定する。  
    単に `false` だけ返した場合は「○○は正しく入力してください」と表示。  
    文字列を返した場合はそれをエラー文に使う。  
    問題なければ `true` を返せばいい。
    
- **その他**  
  項目の選択肢 `options` など、`$input`で参照したいものを自由に足して良い。

    
### `string|bool getEmailReturn()`

自動返信設定。送信先として利用するフィールド名を返すよう実装する。  
自動返信不要な場合は `false` を返せばいい。

### `string|array getFromAddress()`

メールの差出人設定。  
文字列を返した場合はそのまま `From` ヘッダに使われる。  
配列を返した場合は `[0]` を表示名、 `[1]` をメールアドレスとして扱う。  
いずれにしてもエンコードは不要。
    
### `string|null getReplyTo()`

自動返信メールを送る際に設定する返信先。
Fromには返信してほしくないけど、返信先は指定したい場合に。
でも、単にFromに適切なものを設定すれば良い気がする。

### `array getSendTo()`

管理者送信先。配列指定なので複数指定可能。  
宛先ごとに個別にメールを作って送信するので、  
他に誰と誰が受け取ったかはわからないようになっている。

### `array getSendConfig()`
 
メール送信設定。  
通常変更不要だが、SMTPで送信したい場合はここで設定可能。

## その他

- デザイン
  - 電話番号欄や郵便番号欄は分けないほうが（エンドユーザーが）使いやすいと思います。  
    指示があった場合は別ですが、極力分けずにデザインすることをオススメします。
    
  - よくある「* は必須項目です」ではなく、ちゃんと「必須」「任意」と書いたほうが、  
    目の不自由な方や高齢者にもわかりやすいと思います。全く印付けないのは論外です。
    
  - デザイン上「エラー表示」は忘れられがちですが、こちらもちゃんと確認しましょう。  
    エラー時は入力欄を赤くする、などと工夫するのもよいかもしれません。
    
  - たまに入力画面に「リセット」ボタンがあることがありますが、あれは必要でしょうか？  
    誤クリックを招きますし、使う機会もほぼ無いので入れないほうがいいと思います。
    
  - `placeholder` を項目名の代わりに使うのは、HTML5の仕様上、推奨されていません。  
    https://myakura.github.io/n/placeholder.html
    
  - フォームを入力している最中に別ページに飛ぶことはそう多くないと思います。  
    誤ってクリックしてしまい、入力中の内容が消えてしまうことを防ぐためにも、  
    思い切って他ページと別レイアウトにすることを検討してもいいと思います。  
    リンクを貼る場合もできるだけ `target="_blank"` にしましょう。
  
- コーディング
  
  - 同梱の `style.css` はサンプルなので特に読み込み必須ではありません。
    
  - 電話番号や郵便番号欄は `<input type="tel">` を使う、  
    メールアドレス欄は `<input type="email">` を使うなど、HTML5要素をうまく使うと、  
    スマートフォンでもキーボードが変わるので、使いやすいフォームになります。
    
  - PHPでの入力チェックはセキュリティ上対策必須なので実装していますが、  
    これに頼ってしまうと「画面が切り替わらないと正しいかわからない」ことになるので、  
    JavaScriptでも入力チェックを行うと、すぐに入力ミスに気付けて良いと思います。
    
  - 住所の自動入力機能は、もはやデフォルトと言っても過言ではありません。  
    導入も難しくないので、特に指示がなくてもぜひ導入しましょう。  
    https://github.com/yubinbango/yubinbango
    
  - 余力があれば `autocomplete` 属性を付けると楽に入力できるフォームに仕上がります。  
    https://ics.media/entry/11221

- セキュリティ
  - XSSが発生しないよう、入力値は必ず `h()` でエスケープしてから表示すること。
    - ただし、メールテンプレートでは不要（HTMLではないため）
  - CSRF対策済み。
  
## とてもよくある質問

### エラーになったときに入力した値が消えてしまう

HTMLの `<input>` タグで 最初から値が入力された状態にしたいときはどうしたらよいか？  
何も難しいことはなく `value` 属性を使えばいいだけですね。  
サンプルの `input.template.php` を見ると `value` 属性にPHPの記述があるはず！  
コピペ漏れしてないか確認するようにしましょう。  
チェックボックス、ラジオボタン、セレクトボックス、テキストエリアは書き方が少し違うので注意。

また、設定ファイルを正しく書き換えていない場合も値が消えてしまいます。  
`<input>` タグの `name` 属性に指定したものが `config.php` に入っているか確認しましょう。

### 全て正しく入力したはずなのに エラーになって 確認画面に進めない

設定ファイル `config.php` の項目を変更していないのが原因です。  
（例） 性別 `sex` という項目は HTML 上に存在しないのに `config.php` に残ったままになっている  
→ `sex` が 必須（`'required' => true`）になっているために 見えないところでエラーが発生！ 

使用しない入力項目は 残しておかずに 必ず `config.php` から消すようにしてください。  
「この項目はいま存在しないけれど 後で使うかもしれない」なんて心配は不要です。  
フォームの実装に限らず、不要なものを「念の為」で残すのは 後で見たときに混乱の元でしかありません。

### 入力エラーになる状態で送信したつもりなのに エラーにならずに 確認画面に進んでしまう

設定ファイル `config.php` の項目を変更していないのが原因です。  
（例） プライバシーポリシーの同意チェックの `name` を `check` にしたのに `config.php` には `check` なんてない

入力項目を追加する時は HTMLのほうだけではなく 必ず `config.php` も追加するようにしてください。  
また、同じような項目でも `name` を変えた場合は 必ず `config.php` も変更するようにしてください。

### 管理者宛メールも 自動返信メールも届きません

色々な要因が考えられますが、よくある原因をいくつか記載します。  
読んでもよくわからない場合は、わかりそうな人に聞いてみましょう。

- 送信はされているが、スパム判定に引っかかっている
   - 迷惑メールボックスを確認する
   - SPFレコードを確認する
   - サーバーで使用しているIPアドレスがブラックリストに登録されていないか確認する
   - （自分でメールサーバーを立てた場合）メールサーバーの設定を確認する
  
- お問合せフォームを設置したサーバーがメール送信に対応していない
   - SMTPサーバーを指定して送信してみる

- Webサーバーに さくらのレンタルサーバ を使用している
   - DNS関連の問題である可能性があるので SMTPサーバーを指定して送信してみる

- SMTPサーバーを指定してメールを送ろうとしているが、差出人（From）のアドレスが変
   - 指定したSMTPサーバーのアカウントと同じメールアドレスを使って送信する
      - 返信先を変えたいようであれば ReplyTo を使う

- SMTPサーバーを指定してメールを送ろうとしているが、アカウントが間違っている
   - Thunderbird など、一般的なメーラーでメール送信ができるか試してみる

- SMTPサーバーを指定してメールを送ろうとしているが、証明書エラーが出る
   - メールサーバー名が正しいか確認する
   - どうしてもうまくいかない場合は「その他の接続設定（通常指定不要）」のコメントアウトを解除する  

### 管理者宛メールは届くのに 自動返信メールが届きません

設定ファイル `config.php` を変更していないのが原因です。  
`getEmailReturn()` が正しい設定になっているか 確認してください。  
（例）メールアドレスの入力欄を `<input type="email" name="mailaddr">` として作った  
→ `getEmailReturn()` は `return 'mailaddr';` というように `name` と同じにする必要がある

## TODO

今後対応を検討したいもの

- エラー表示やチェックボックスやラジオボタンの `checked` 判定など、テンプレート内の表記を簡略化
   - PHP 5.4 以降だと `<?php echo h($var); ?>` を `<?= h($var); ?>` と書けるので、これだけでもゴチャゴチャ感は減る？
   - `$input[$name]['value']` をエスケープ済みにしてしまえば `h()` も削れるかも（生の値は別で持つ）
- もっとシンプルなファイル構成に
   - お問い合わせフォームのためにあんまりたくさんファイルをアップしたくない
   - 編集可能なファイル以外はAdminerみたいに1ファイルにまとめたい
      - あれどうやってるんだろうと思ったら割と自力でやってるぽかった……
- オレオレフレームワークの廃止
